@using Microsoft.Data.SqlClient;
@using PATHSMap.Data;
@using Microsoft.Data.Sql;
@using System.Data;
@using Microsoft.Extensions.Configuration;
@page "/eventlist"

<link href="EventList.razor.css" rel="stylesheet" />
<div class="container">
    <div class="content">
        <p>Last update was at @lastInquiryTime Central Time.</p>
        @if (storms.Any())
        {
            @foreach (var storm in storms)
            {
                <h3>@storm.headline</h3>
                /*<p>@storm.description</p>*/
            }
        }
        else
        {
            <p>No active severe weather events in the United States.</p>
        }

        
        
        @code {
            //DB query logic for event list
            //Only the storms that were successfully created in the DB will be displayed
            private IEnumerable<Storm> storms = new List<Storm>();
            private string lastInquiryTime = "";
            
            protected override async Task OnInitializedAsync()
            {
                var config = new ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile("appsettings.json")
                .Build();
                string connString = config.GetConnectionString("DefaultConnection");
                IDbConnection conn = new SqlConnection(connString);
                {
                    var stormRepo = new StormRepository(conn);
                    storms = stormRepo.GetAllStorms();
                    lastInquiryTime = DateTime.Now.ToString("h:mm:ss tt");
                }

                while (true)
                {
                    await Task.Delay(30000);

                    conn = new SqlConnection(connString);
                    {
                        var stormRepo = new StormRepository(conn);
                        storms = stormRepo.GetAllStorms();
                        lastInquiryTime = DateTime.Now.ToString("h:mm:ss tt");
                        StateHasChanged();
                    }
                }
            }
        }
    </div>
</div>

